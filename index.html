<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteador de Times (Lista Pública)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a472a;
            background-image: radial-gradient(#2d6a4f 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .title-font { font-family: 'Russo One', sans-serif; }

        .player-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .player-card.selected {
            background-color: #d1fae5;
            border-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .player-card.selected .check-icon { opacity: 1; transform: scale(1); }
        .check-icon { opacity: 0; transform: scale(0.5); transition: all 0.2s; }

        .field-pattern {
            background: repeating-linear-gradient(0deg, #2f855a, #2f855a 20px, #276749 20px, #276749 40px);
        }

        .nav-tab.active {
            background-color: #fbbf24; color: #78350f; border-bottom: 4px solid #b45309;
        }
        .nav-tab.inactive {
            background-color: rgba(255,255,255,0.1); color: #d1fae5;
        }

        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #fbbf24;
            border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .glass-modal { background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="min-h-screen text-gray-100 pb-20">

    <!-- Cabeçalho -->
    <header class="bg-gradient-to-r from-green-900 to-green-950 shadow-xl sticky top-0 z-20 border-b border-green-700">
        <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i data-lucide="trophy" class="text-yellow-400 w-6 h-6"></i>
                <h1 class="text-xl md:text-2xl title-font text-white tracking-wider uppercase">Pelada PRO <span class="text-[10px] bg-purple-600 px-1 rounded align-middle">ONLINE</span></h1>
            </div>
            
            <div class="flex bg-green-900/50 p-1 rounded-lg">
                <button onclick="switchMode('roster')" id="btnRoster" class="nav-tab active px-4 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-all">
                    <i data-lucide="users" class="w-4 h-4"></i> Escalação
                </button>
                <button onclick="attemptLogin()" id="btnConfig" class="nav-tab inactive px-4 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-all">
                    <i id="lockIcon" data-lucide="lock" class="w-3 h-3"></i> Gerenciar
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto p-4 space-y-6">

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-green-900/80 backdrop-blur z-50 flex flex-col items-center justify-center">
            <div class="loader mb-4 w-12 h-12 border-4"></div>
            <p class="animate-pulse font-bold text-yellow-400">Sincronizando Lista Pública...</p>
        </div>

        <!-- Modal de Senha -->
        <div id="passwordModal" class="fixed inset-0 glass-modal z-50 flex flex-col items-center justify-center hidden p-4">
            <div class="bg-white text-gray-900 rounded-xl p-6 max-w-sm w-full shadow-2xl space-y-4">
                <div class="text-center">
                    <div class="bg-red-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i data-lucide="lock" class="text-red-600 w-6 h-6"></i>
                    </div>
                    <h3 class="font-bold text-xl">Área Restrita</h3>
                    <p class="text-sm text-gray-500">Digite a senha para gerenciar jogadores.</p>
                </div>
                <input type="password" id="adminPassword" class="w-full text-center text-2xl tracking-widest px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-green-500 outline-none" placeholder="****" maxlength="4">
                <div class="flex gap-2">
                    <button onclick="closeLogin()" class="flex-1 bg-gray-200 hover:bg-gray-300 font-bold py-3 rounded-lg text-gray-700">Cancelar</button>
                    <button onclick="checkPassword()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Entrar</button>
                </div>
            </div>
        </div>

        <!-- MODO 1: ESCALAÇÃO -->
        <div id="rosterView" class="space-y-6">
            <div class="bg-green-800/90 backdrop-blur rounded-xl p-4 border border-green-600 shadow-lg flex flex-col md:flex-row justify-between items-center gap-4 sticky top-20 z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-green-900 p-2 rounded-full">
                        <i data-lucide="check-square" class="text-green-400"></i>
                    </div>
                    <div>
                        <p class="text-xs text-green-300 uppercase font-bold tracking-wider">Confirmados</p>
                        <p class="text-xl font-bold text-white"><span id="selectedCount" class="text-yellow-400 text-2xl">0</span> jogadores</p>
                    </div>
                </div>

                <div class="flex items-center gap-3 bg-black/20 p-2 rounded-lg">
                    <span class="text-sm">Por time:</span>
                    <button onclick="adjustTeamSize(-1)" class="w-8 h-8 bg-white/10 hover:bg-white/20 rounded font-bold">-</button>
                    <span id="teamSizeDisplay" class="font-bold w-6 text-center">6</span>
                    <button onclick="adjustTeamSize(1)" class="w-8 h-8 bg-white/10 hover:bg-white/20 rounded font-bold">+</button>
                </div>
            </div>

            <div>
                <h3 class="text-sm font-bold text-green-200 mb-2 uppercase tracking-wide flex justify-between">
                    <span>Quem vai jogar hoje?</span>
                    <span class="text-xs font-normal normal-case opacity-70">Toque para selecionar</span>
                </h3>
                
                <div id="rosterGrid" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
                <div id="emptyRosterMsg" class="hidden text-center py-10 opacity-60">
                    <i data-lucide="ghost" class="w-12 h-12 mx-auto mb-2 text-green-300"></i>
                    <p>Nenhum jogador encontrado na lista pública.</p>
                </div>
            </div>

            <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-green-900 via-green-900/90 to-transparent pointer-events-none flex justify-center z-20">
                <button onclick="sortTeamsIntelligent()" id="btnSort" class="pointer-events-auto bg-yellow-500 hover:bg-yellow-400 text-yellow-950 font-black py-4 px-12 rounded-full shadow-2xl transform transition hover:-translate-y-1 active:scale-95 flex items-center gap-3 text-xl border-b-4 border-yellow-700 max-w-md w-full justify-center">
                    <i data-lucide="shuffle"></i> SORTEAR TIMES
                </button>
            </div>
        </div>

        <!-- MODO 2: GERENCIAR (Protegido) -->
        <div id="configView" class="hidden space-y-6">
            <section class="bg-white text-gray-800 rounded-xl shadow-xl overflow-hidden border-2 border-yellow-500/50">
                <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="font-bold text-green-800 flex items-center gap-2" id="formTitle">
                        <i data-lucide="user-plus" class="w-5 h-5"></i> Novo Jogador
                    </h2>
                    <button onclick="cancelEdit()" id="btnCancelEdit" class="hidden text-xs text-red-500 font-bold hover:bg-red-50 px-2 py-1 rounded">CANCELAR EDIÇÃO</button>
                </div>
                
                <div class="p-5 space-y-4">
                    <div>
                        <input type="text" id="playerName" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-green-500 outline-none text-lg bg-gray-50" placeholder="Nome do Jogador" onkeypress="handleEnter(event)">
                    </div>

                    <div class="flex items-center gap-4 bg-gray-100 p-3 rounded-lg border border-gray-200">
                         <div class="flex-1">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="isGoalkeeper" class="w-5 h-5 text-green-600 rounded focus:ring-green-500">
                                <span class="font-bold text-gray-700">É Goleiro?</span>
                                <i data-lucide="hand" class="w-4 h-4 text-gray-500"></i>
                            </label>
                         </div>
                    </div>

                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-xs font-bold text-gray-500 uppercase">Nível de Habilidade</label>
                            <span id="skillLabel" class="text-xs font-bold text-green-600">Médio (3)</span>
                        </div>
                        <div class="flex gap-2 justify-center bg-gray-100 p-3 rounded-lg border border-gray-200" id="starContainer"></div>
                    </div>

                    <button onclick="savePlayer()" id="btnSavePlayer" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow transform transition active:scale-95 flex items-center justify-center gap-2">
                        <i data-lucide="save"></i> Salvar na Nuvem Pública
                    </button>
                </div>
            </section>

            <section>
                <div class="flex justify-between items-end mb-3">
                    <h3 class="font-bold text-lg text-white">Banco Público de Jogadores</h3>
                    <div id="syncStatus" class="text-xs text-green-300 animate-pulse hidden">Sincronizando...</div>
                </div>
                <div id="configList" class="space-y-2"></div>
                <div class="text-center mt-6">
                    <button onclick="clearAllData()" class="text-xs text-red-400 hover:text-red-200 underline">Apagar dados de TODOS os usuários</button>
                </div>
            </section>
        </div>

        <!-- TELA DE RESULTADO -->
        <div id="resultView" class="hidden space-y-8 pt-4">
            <div class="flex items-center justify-between">
                <button onclick="backToRoster()" class="text-white hover:text-yellow-300 flex items-center gap-1 font-bold bg-black/20 px-3 py-2 rounded-lg">
                    <i data-lucide="arrow-left"></i> Voltar
                </button>
                <h2 class="title-font text-2xl text-yellow-400">Times Sorteados</h2>
                <div class="w-20"></div>
            </div>

            <div id="analysisMsg" class="text-center text-xs bg-black/30 p-2 rounded text-green-200 hidden"></div>

            <div id="teamsContainer" class="grid md:grid-cols-2 gap-6"></div>
            
            <div id="leftoversContainer" class="hidden mt-8 border-t border-green-700 pt-6">
                <h3 class="text-center font-bold text-green-300 uppercase tracking-widest mb-4 flex items-center justify-center gap-2">
                    <i data-lucide="clock"></i> Próximos Jogos (Banco)
                </h3>
                <div id="leftoversList" class="grid grid-cols-2 gap-3 opacity-80"></div>
            </div>
            
            <div class="fixed bottom-6 right-6 z-30">
                <button onclick="copyToClipboard()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold p-4 rounded-full shadow-2xl flex items-center gap-2 animate-bounce">
                    <i data-lucide="copy" class="w-6 h-6"></i>
                </button>
            </div>
        </div>

    </main>

    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gray-900/95 text-white px-6 py-3 rounded-full shadow-xl translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3 whitespace-nowrap backdrop-blur">
        <i data-lucide="check-circle" class="text-green-400"></i>
        <span id="toastMsg">Mensagem</span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuZveL9LVmvsvIhrvOUbab3MGA8LPoeq0",
            authDomain: "futebol-27972.firebaseapp.com",
            projectId: "futebol-27972",
            storageBucket: "futebol-27972.firebasestorage.app",
            messagingSenderId: "447653679842",
            appId: "1:447653679842:web:5107789bb7db36519dc4bb",
            measurementId: "G-0QKTVYHC7P"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let userId = null;
        let players = []; 
        
        window.teamSize = 6;
        window.currentRating = 3;
        window.isAuthenticated = false;
        window.editingId = null; 
        const APP_PASSWORD = "1937";

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.warn("Auth fallback", error);
                try { await signInAnonymously(auth); } 
                catch (e) { document.getElementById('loadingOverlay').innerHTML = '<p class="text-red-400 p-4">Erro de conexão</p>'; }
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('loadingOverlay').classList.add('hidden');
                setupRealtimeListener();
            }
        });

        // --- LISTENER PÚBLICO ---
        function setupRealtimeListener() {
            const q = query(collection(db, 'artifacts', 'futebol_app', 'public', 'data', 'players'));
            onSnapshot(q, (snapshot) => {
                players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
                document.getElementById('syncStatus').classList.remove('hidden');
                setTimeout(() => document.getElementById('syncStatus').classList.add('hidden'), 1000);
            }, (err) => console.error("Erro leitura:", err));
        }

        window.attemptLogin = () => {
            if (window.isAuthenticated) { switchMode('config'); } 
            else { document.getElementById('passwordModal').classList.remove('hidden'); document.getElementById('adminPassword').value = ''; document.getElementById('adminPassword').focus(); }
        }

        window.closeLogin = () => document.getElementById('passwordModal').classList.add('hidden');

        window.checkPassword = () => {
            if (document.getElementById('adminPassword').value === APP_PASSWORD) {
                window.isAuthenticated = true;
                closeLogin();
                switchMode('config');
                showToast("Acesso Liberado");
                document.getElementById('lockIcon').setAttribute('data-lucide', 'unlock');
                lucide.createIcons();
            } else {
                showToast("Senha incorreta!", true);
            }
        }

        // --- SALVAR NO PÚBLICO ---
        window.savePlayer = async () => {
            if (!auth.currentUser) return;
            const name = document.getElementById('playerName').value.trim();
            const isGK = document.getElementById('isGoalkeeper').checked;
            if (!name) { showToast("Digite um nome!", true); return; }

            const btn = document.getElementById('btnSavePlayer');
            btn.disabled = true;

            const playerData = {
                name: name,
                skill: Number(window.currentRating),
                isGoalkeeper: isGK
            };

            try {
                // Referência para coleção pública
                const publicCol = collection(db, 'artifacts', 'futebol_app', 'public', 'data', 'players');

                if (window.editingId) {
                    await updateDoc(doc(publicCol, window.editingId), playerData);
                    showToast(`${name} atualizado!`);
                    window.cancelEdit();
                } else {
                    playerData.selected = true;
                    playerData.createdAt = Date.now();
                    await addDoc(publicCol, playerData);
                    showToast(`${name} adicionado!`);
                    document.getElementById('playerName').value = '';
                    document.getElementById('isGoalkeeper').checked = false;
                    setRating(3);
                }
                document.getElementById('playerName').focus();
            } catch (e) {
                console.error(e);
                showToast("Erro ao salvar", true);
            } finally {
                btn.disabled = false;
            }
        }

        window.startEdit = (id) => {
            const p = players.find(x => x.id === id);
            if (!p) return;
            window.editingId = id;
            document.getElementById('playerName').value = p.name;
            document.getElementById('isGoalkeeper').checked = !!p.isGoalkeeper;
            setRating(p.skill);
            
            const btn = document.getElementById('btnSavePlayer');
            btn.innerHTML = `<i data-lucide="refresh-cw"></i> Atualizar Jogador`;
            btn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transform transition active:scale-95 flex items-center justify-center gap-2";
            
            const title = document.getElementById('formTitle');
            title.innerHTML = `<i data-lucide="edit"></i> Editando: ${p.name}`;
            title.className = "font-bold text-blue-600 flex items-center gap-2";
            document.getElementById('btnCancelEdit').classList.remove('hidden');
            
            document.getElementById('configView').scrollIntoView({behavior: 'smooth'});
            document.getElementById('playerName').focus();
            lucide.createIcons();
        }

        window.cancelEdit = () => {
            window.editingId = null;
            document.getElementById('playerName').value = '';
            document.getElementById('isGoalkeeper').checked = false;
            setRating(3);
            
            const btn = document.getElementById('btnSavePlayer');
            btn.innerHTML = `<i data-lucide="save"></i> Salvar na Nuvem Pública`;
            btn.className = "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow transform transition active:scale-95 flex items-center justify-center gap-2";
            
            const title = document.getElementById('formTitle');
            title.innerHTML = `<i data-lucide="user-plus" class="w-5 h-5"></i> Novo Jogador`;
            title.className = "font-bold text-green-800 flex items-center gap-2";
            document.getElementById('btnCancelEdit').classList.add('hidden');
            lucide.createIcons();
        }

        // --- REMOVER DO PÚBLICO ---
        window.removePlayer = async (docId) => {
            if (!auth.currentUser) return;
            if(confirm('Apagar jogador da lista pública?')) {
                if(window.editingId === docId) window.cancelEdit();
                await deleteDoc(doc(db, 'artifacts', 'futebol_app', 'public', 'data', 'players', docId));
            }
        }

        function renderConfigList() {
            const list = document.getElementById('configList');
            const sorted = [...players].sort((a,b) => b.createdAt - a.createdAt);
            list.innerHTML = sorted.map(p => `
                <div class="bg-white/10 backdrop-blur border border-white/10 rounded-lg p-3 flex justify-between items-center ${window.editingId === p.id ? 'border-blue-400 bg-blue-900/20' : ''}">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 flex-shrink-0 rounded-full ${p.isGoalkeeper ? 'bg-orange-600 border-orange-400' : 'bg-green-800 border-yellow-500/30'} flex items-center justify-center font-bold text-white text-sm border">
                            ${p.isGoalkeeper ? '<i data-lucide="hand" class="w-4 h-4"></i>' : p.skill}
                        </div>
                        <div class="flex flex-col overflow-hidden">
                            <span class="font-medium text-white truncate">${p.name} ${p.isGoalkeeper ? '<span class="text-[10px] bg-orange-500 px-1 rounded">GK</span>' : ''}</span>
                            <div class="flex text-yellow-500 text-[10px] opacity-70">
                                ${'★'.repeat(p.skill)}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-1 flex-shrink-0">
                        <button onclick="startEdit('${p.id}')" class="text-blue-300 hover:bg-blue-900/50 p-2 rounded transition" title="Editar">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                        <button onclick="removePlayer('${p.id}')" class="text-red-400 hover:bg-red-900/50 p-2 rounded transition" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        window.handleEnter = (e) => { if (e.key === 'Enter') window.savePlayer(); }
        
        window.switchMode = (mode) => {
            document.getElementById('resultView').classList.add('hidden');
            if (mode === 'roster') {
                document.getElementById('rosterView').classList.remove('hidden');
                document.getElementById('configView').classList.add('hidden');
                document.getElementById('btnRoster').classList.replace('inactive', 'active');
                document.getElementById('btnConfig').classList.replace('active', 'inactive');
            } else {
                document.getElementById('rosterView').classList.add('hidden');
                document.getElementById('configView').classList.remove('hidden');
                document.getElementById('btnRoster').classList.replace('active', 'inactive');
                document.getElementById('btnConfig').classList.replace('inactive', 'active');
                window.cancelEdit(); 
            }
            updateUI();
        }

        // --- ATUALIZAR STATUS NO PÚBLICO ---
        window.toggleSelection = async (docId) => {
            if (!auth.currentUser) return;
            const p = players.find(x => x.id === docId);
            if (p) {
                // Otimista
                const card = document.querySelector(`[data-id="${docId}"]`);
                if(card) card.classList.toggle('selected');
                
                await updateDoc(doc(db, 'artifacts', 'futebol_app', 'public', 'data', 'players', docId), { selected: !p.selected });
            }
        }
        
        window.clearAllData = async () => {
            if (!auth.currentUser) return;
            if(confirm("CUIDADO: Isso apagará a lista PÚBLICA inteira para todos!")) {
                players.forEach(async p => await deleteDoc(doc(db, 'artifacts', 'futebol_app', 'public', 'data', 'players', p.id)));
            }
        }

        async function getLastGameHistory() {
            if (!auth.currentUser) return null;
            try {
                const q = query(collection(db, 'artifacts', 'futebol_app', 'public', 'data', 'history'), orderBy('createdAt', 'desc'), limit(1));
                const s = await getDocs(q);
                return s.empty ? null : s.docs[0].data();
            } catch (e) { return null; }
        }
        
        async function saveGameHistory(teams) {
             if (!auth.currentUser) return;
             try {
                await addDoc(collection(db, 'artifacts', 'futebol_app', 'public', 'data', 'history'), { createdAt: Date.now(), teams: teams.map(t => t.members.map(p => p.name)) });
             } catch (e) {}
        }

        window.sortTeamsIntelligent = async () => {
            const active = players.filter(p => p.selected);
            if (active.length < window.teamSize) { 
                showToast(`Selecione pelo menos ${window.teamSize} jogadores!`, true); 
                return; 
            }
            
            const btn = document.getElementById('btnSort');
            const txt = btn.innerHTML;
            btn.innerHTML = `<div class="loader w-6 h-6 border-white border-t-transparent"></div>`;
            btn.disabled = true;

            try {
                const last = await getLastGameHistory();
                let best = null, lowScore = Infinity;
                
                for (let i=0; i<20; i++) {
                    const result = genTeams(active, window.teamSize);
                    let sc = last ? calcRep(result.teams, last.teams) : 0;
                    if (sc < lowScore || (sc === lowScore && Math.random()>0.5)) { 
                        lowScore = sc; 
                        best = result; 
                    }
                }
                
                if (best) {
                    renderResults(best.teams, best.leftovers, lowScore, !!last);
                    saveGameHistory(best.teams); 
                } else {
                    throw new Error("Falha ao gerar times");
                }

            } catch (e) { 
                console.error("Erro no sorteio:", e); 
                showToast("Erro ao processar sorteio", true); 
            } finally { 
                btn.innerHTML = txt; 
                btn.disabled = false; 
            }
        }

        function genTeams(list, teamSize) {
            let gks = list.filter(p => p.isGoalkeeper);
            let field = list.filter(p => !p.isGoalkeeper);
            
            const numTeams = Math.floor(list.length / teamSize);
            
            if (numTeams < 1) {
                return { teams: [{members: list, totalSkill: 0}], leftovers: [] };
            }

            let teams = Array.from({length: numTeams}, () => ({members: [], totalSkill: 0}));
            let leftovers = [];

            // 1. Distribuir Goleiros
            gks = gks.sort(() => Math.random() - 0.5);
            for (let i = 0; i < numTeams; i++) {
                if (i < gks.length) {
                    teams[i].members.push(gks[i]);
                    teams[i].totalSkill += (parseInt(gks[i].skill) || 3);
                }
            }
            if (gks.length > numTeams) gks.slice(numTeams).forEach(g => leftovers.push(g));

            // 2. Ordenar Linha
            let buckets = {5:[],4:[],3:[],2:[],1:[]};
            field.forEach(p => {
                let s = parseInt(p.skill);
                if (isNaN(s) || s < 1 || s > 5) s = 3; 
                buckets[s].push(p);
            });
            for(let k in buckets) buckets[k] = buckets[k].sort(()=>Math.random()-0.5);
            
            let sortedField = []; 
            [5,4,3,2,1].forEach(l => sortedField = sortedField.concat(buckets[l]));

            // 3. Preencher Times (Corrigido para usar contagem total)
            let slotsFilledByGk = 0;
            teams.forEach(t => slotsFilledByGk += t.members.length);
            const totalSlots = numTeams * teamSize;
            const fieldSlotsNeeded = totalSlots - slotsFilledByGk;

            sortedField.forEach((p, i) => {
                if (i < fieldSlotsNeeded) {
                    // Distribui equilibrando habilidade
                    let availableTeams = teams.map((t, idx) => ({...t, idx})).filter(t => t.members.length < teamSize);
                    
                    if (availableTeams.length > 0) {
                        availableTeams.sort((a, b) => {
                            if (a.totalSkill !== b.totalSkill) return a.totalSkill - b.totalSkill;
                            return a.members.length - b.members.length;
                        });
                        let targetIdx = availableTeams[0].idx;
                        teams[targetIdx].members.push(p);
                        teams[targetIdx].totalSkill += (parseInt(p.skill) || 3);
                    }
                } else {
                    leftovers.push(p);
                }
            });

            return { teams, leftovers };
        }

        function calcRep(newT, lastT) {
            let c=0, pairs=new Set();
            if(!lastT) return 0;
            lastT.forEach(grp=>{
                if(!grp) return;
                for(let i=0;i<grp.length;i++) for(let j=i+1;j<grp.length;j++) pairs.add([grp[i],grp[j]].sort().join('|'));
            });
            newT.forEach(tm=>{
                let m=tm.members;
                for(let i=0;i<m.length;i++) for(let j=i+1;j<m.length;j++) if(pairs.has([m[i].name,m[j].name].sort().join('|'))) c++;
            });
            return c;
        }

        window.updateUI = () => { renderRoster(); renderConfigList(); updateCounts(); lucide.createIcons(); }
        
        function renderRoster() {
            const g=document.getElementById('rosterGrid'), m=document.getElementById('emptyRosterMsg');
            if(!players.length){ g.innerHTML=''; m.classList.remove('hidden'); return;}
            m.classList.add('hidden');
            g.innerHTML = [...players].sort((a,b)=>a.name.localeCompare(b.name)).map(p=>`
                <div onclick="toggleSelection('${p.id}')" data-id="${p.id}" class="player-card cursor-pointer bg-white text-gray-800 rounded-lg p-3 border-2 ${p.selected?'selected border-green-600':'border-transparent'} relative overflow-hidden select-none">
                    <div class="flex justify-between items-center z-10 relative">
                        <span class="font-bold truncate pr-2 flex items-center gap-1">
                            ${p.isGoalkeeper ? '<i data-lucide="hand" class="w-3 h-3 text-orange-600"></i>' : ''}
                            ${p.name}
                        </span>
                        <div class="check-icon bg-green-600 text-white rounded-full p-0.5"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><polyline points="20 6 9 17 4 12"/></svg></div>
                    </div>
                </div>`).join('');
        }

        function renderResults(teams, leftovers, sc, hist) {
            document.getElementById('rosterView').classList.add('hidden');
            document.getElementById('resultView').classList.remove('hidden');
            
            const msg = document.getElementById('analysisMsg');
            if(hist) {
                msg.classList.remove('hidden');
                msg.innerHTML = sc===0?`<span class="text-yellow-400">★ Sorteio Perfeito!</span> Sem repetições.`:`Evitando panelas (${sc} pares mantidos).`;
            } else msg.classList.add('hidden');
            
            document.getElementById('teamsContainer').innerHTML = teams.map((t,i)=>`
                <div class="field-pattern rounded-xl overflow-hidden shadow-2xl border-4 border-white h-fit">
                    <div class="bg-gray-900 p-3 text-center border-b-2 border-yellow-500">
                        <h3 class="text-xl font-black text-white uppercase tracking-wider">Time ${i+1}</h3>
                        <div class="flex justify-center gap-4 text-xs text-gray-400 mt-1">
                            <span>Jogadores: <strong class="text-white">${t.members.length}</strong></span>
                        </div>
                    </div>
                    <div class="p-4 space-y-2">
                        ${t.members.map(p=>`
                            <div class="flex justify-between items-center bg-white/95 p-2 rounded shadow-sm ${p.isGoalkeeper ? 'border-l-4 border-orange-500' : ''}">
                                <span class="font-bold text-gray-900 flex items-center gap-2">
                                    <i data-lucide="${p.isGoalkeeper ? 'hand' : 'shirt'}" class="w-4 h-4 ${p.isGoalkeeper ? 'text-orange-600' : 'text-green-700'}"></i>
                                    ${p.name}
                                </span>
                            </div>`).join('')}
                    </div>
                </div>`).join('');
            
            // Render Leftovers
            const lContainer = document.getElementById('leftoversContainer');
            const lList = document.getElementById('leftoversList');
            if (leftovers && leftovers.length > 0) {
                lContainer.classList.remove('hidden');
                lList.innerHTML = leftovers.map(p => `
                    <div class="bg-gray-800 p-2 rounded text-gray-300 flex items-center justify-between">
                         <span class="flex items-center gap-2 text-sm font-bold">
                            <i data-lucide="${p.isGoalkeeper ? 'hand' : 'user'}" class="w-3 h-3"></i> ${p.name}
                         </span>
                    </div>
                `).join('');
            } else {
                lContainer.classList.add('hidden');
            }

            window.scrollTo({top:0, behavior:'smooth'}); 
            lucide.createIcons();
        }

        window.adjustTeamSize = (d) => { let v=window.teamSize+d; if(v<2)v=2; if(v>20)v=20; window.teamSize=v; updateCounts(); }
        window.updateCounts = () => {
            document.getElementById('selectedCount').innerText = players.filter(p=>p.selected).length;
            document.getElementById('teamSizeDisplay').innerText = window.teamSize;
        }
        window.backToRoster = () => switchMode('roster');
        window.setRating = (v) => {
            window.currentRating = v;
            const c = document.getElementById('starContainer');
            c.innerHTML='';
            for(let i=1;i<=5;i++){
                const a = i<=v;
                const s = document.createElement('div');
                s.className='cursor-pointer p-1';
                s.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="${a?'#fbbf24':'#e5e7eb'}" stroke="${a?'#b45309':'#9ca3af'}" stroke-width="1.5" class="transition-transform hover:scale-110"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`;
                s.onclick=()=>setRating(i);
                c.appendChild(s);
            }
            document.getElementById('skillLabel').innerText = ["Perna de Pau (1)","Iniciante (2)","Médio (3)","Bom (4)","Craque (5)"][v-1];
        }
        window.showToast = (msg, err=false) => {
            const t = document.getElementById('toast'), i = t.querySelector('i');
            document.getElementById('toastMsg').innerText = msg;
            i.setAttribute('data-lucide', err?'alert-circle':'check-circle');
            i.className = err?'text-red-400':'text-green-400';
            lucide.createIcons();
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(()=>t.classList.add('translate-y-20', 'opacity-0'),3000);
        }
        window.copyToClipboard = () => {
            let t = "⚽ *TIMES SORTEADOS* ⚽\n\n";
            document.getElementById('teamsContainer').childNodes.forEach(c=>{
                if(!c.innerText)return;
                let l=c.innerText.split('\n').filter(x=>x.trim());
                t+=`*${l[0]}* (${l[1]})\n`;
                for(let i=2;i<l.length;i++) t+=`- ${l[i]}\n`;
                t+='\n';
            });
            const lList = document.getElementById('leftoversList');
            if (lList && lList.children.length > 0) {
                t += "*PRÓXIMOS JOGOS:*\n";
                for (let child of lList.children) {
                    t += `- ${child.querySelector('span').innerText.trim()}\n`;
                }
            }
            navigator.clipboard.writeText(t).then(()=>showToast("Copiado!"));
        }
        
        setRating(3);
    </script>
</body>
</html>